@model List<RealEstateCRM.Models.ViewModels.UserListItemViewModel>

@{
    ViewData["Title"] = "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏";
}

<div class="wrap">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏</h2>
        <div>
            <a href="@Url.Action("AuditLogs")" class="btn" style="margin-right: 8px;">
                Audit Log
            </a>
            <a href="@Url.Action("Settings")" class="btn" style="margin-right: 8px;">
                –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            </a>
            <button type="button" class="btn" onclick="openCreateUserModal()">
                + –ù–æ–≤ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª
            </button>
        </div>
    </div>

    <div id="messageContainer"></div>

    @if (TempData["Success"] != null)
    {
        <div style="padding: 12px; margin-bottom: 16px; background: #f0f0f0; border: 1px solid #000;">
            @TempData["Success"]
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div style="padding: 12px; margin-bottom: 16px; background: #fee; border: 1px solid #c00; color: #c00;">
            @TempData["Error"]
        </div>
    }

    <table>
        <thead>
            <tr>
                <th>–ò–º–µ–π–ª</th>
                <th>–ò–º–µ</th>
                <th>–†–æ–ª–∏</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>Email –ø–æ—Ç–≤—ä—Ä–¥–µ–Ω</th>
                <th style="text-align: right;">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var user in Model)
            {
                <tr>
                    <td>@user.Email</td>
                    <td>@user.FullName</td>
                    <td>
                        @foreach (var role in user.Roles)
                        {
                            <span class="badge">@role</span>
                        }
                        @if (!user.Roles.Any())
                        {
                            <span style="color: #999;">–ù—è–º–∞ —Ä–æ–ª—è</span>
                        }
                    </td>
                    <td>
                        @if (user.IsLockedOut)
                        {
                            <span class="badge">üîí –ó–∞–∫–ª—é—á–µ–Ω</span>
                        }
                        else
                        {
                            <span class="badge">‚úì –ê–∫—Ç–∏–≤–µ–Ω</span>
                        }
                    </td>
                    <td>
                        @if (user.EmailConfirmed)
                        {
                            <span>‚úì</span>
                        }
                        else
                        {
                            <span>‚úó</span>
                        }
                    </td>
                    <td style="text-align: right;">
                        <button type="button" class="btn secondary" style="margin-right: 4px;" onclick="openEditUserModal('@user.Id')">
                            –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π
                        </button>
                        
                        <form asp-action="ToggleLockout" method="post" style="display: inline;">
                            <input type="hidden" name="id" value="@user.Id" />
                            <button type="submit" class="btn secondary" style="margin-right: 4px;">
                                @(user.IsLockedOut ? "üîì –û—Ç–∫–ª—é—á–∏" : "üîí –ó–∞–∫–ª—é—á–∏")
                            </button>
                        </form>
                        
                        <button type="button" class="btn secondary" onclick="confirmAndSubmit('delete-@user.Id', '–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ @user.Email?')">
                            –ò–∑—Ç—Ä–∏–π
                        </button>
                        <form id="delete-@user.Id" asp-action="DeleteUser" method="post" style="display: none;">
                            <input type="hidden" name="id" value="@user.Id" />
                        </form>
                    </td>
                </tr>
            }
            @if (!Model.Any())
            {
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                        –ù—è–º–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Modal -->
<div id="userModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: relative; max-width: 600px; margin: 50px auto; background: #fff; border: 1px solid #000; padding: 24px;">
        <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <h3 id="modalTitle">–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª</h3>
            <button type="button" onclick="closeModal()" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        <div id="modalContent">
            <!-- Form will load here -->
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        function openCreateUserModal() {
            document.getElementById('modalTitle').textContent = '–°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª';
            document.getElementById('userModal').style.display = 'block';
            
            fetch('@Url.Action("GetCreateUserForm")')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('modalContent').innerHTML = html;
                    initFormHandlers();
                });
        }

        function openEditUserModal(userId) {
            document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–∞–Ω–µ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª';
            document.getElementById('userModal').style.display = 'block';
            
            fetch('@Url.Action("GetEditUserForm")?id=' + userId)
                .then(response => response.text())
                .then(html => {
                    document.getElementById('modalContent').innerHTML = html;
                    initFormHandlers();
                });
        }

        function closeModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        function initFormHandlers() {
            const form = document.querySelector('#modalContent form');
            if (!form) return;

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(form);
                const actionUrl = form.id === 'createUserForm' ? '@Url.Action("CreateUser")' : '@Url.Action("EditUser")';
                
                fetch(actionUrl, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'RequestVerificationToken': formData.get('__RequestVerificationToken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        closeModal();
                        showMessage(data.message, 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showMessage(data.errors ? data.errors.join('<br>') : '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∞–∑–≤–∞–Ω–µ', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ —Ñ–æ—Ä–º–∞—Ç–∞', 'error');
                });
            });
        }

        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            const style = type === 'success' 
                ? 'padding: 12px; margin-bottom: 16px; background: #f0f0f0; border: 1px solid #000;'
                : 'padding: 12px; margin-bottom: 16px; background: #fee; border: 1px solid #c00; color: #c00;';
            container.innerHTML = `<div style="${style}">${message}</div>`;
        }

        // Close modal on outside click
        document.getElementById('userModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // helper to show confirm and submit form
        function confirmAndSubmit(formId, message){
            showConfirm(message, '–ü–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ').then(ok => {
                if(ok) document.getElementById(formId).submit();
            });
        }
    </script>
}
