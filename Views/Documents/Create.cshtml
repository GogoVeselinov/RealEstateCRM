@model RealEstateCRM.Models.ViewModels.DocumentTemplateEditViewModel

@{
    ViewData["Title"] = Model.Id.HasValue ? "Редакция на шаблон" : "Създаване на шаблон";
}

<style>
.template-editor {
    max-width: 950px;
    margin: 0 auto;
}

.card {
    border: 1px solid #000;
    padding: 20px;
    background: #fff;
}

.section {
    margin-bottom: 24px;
}

.section h4 {
    margin: 0 0 10px 0;
    padding-bottom: 6px;
    border-bottom: 1px solid #e5e5e5;
}

.input,
.select,
.textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid #000;
}

.textarea {
    min-height: 260px;
    font-family: monospace;
    font-size: 13px;
    background: #fafafa;
}

.json-valid {
    color: green;
    font-size: 13px;
}

.json-invalid {
    color: #900;
    font-size: 13px;
}

.helper-box {
    background: #f7f7f7;
    border: 1px solid #e5e5e5;
    padding: 10px;
    font-size: 13px;
    margin-top: 8px;
}

.actions {
    display: flex;
    gap: 10px;
}
</style>

<div class="template-editor">

    <h2>@ViewData["Title"]</h2>

    <div class="card">

        <form asp-action="Create" method="post" id="template-form">

            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="Id" />

            <!-- BASIC INFO -->
            <div class="section">
                <h4>Основна информация</h4>

                <div style="display:grid; gap:12px;">
                    <div>
                        <label asp-for="Name"></label>
                        <input asp-for="Name" class="input" />
                    </div>

                    <div>
                        <label asp-for="Category"></label>
                        <input asp-for="Category" class="input" />
                    </div>

                    <div>
                        <label asp-for="TemplateType"></label>
                        <select asp-for="TemplateType"
                                asp-items="Html.GetEnumSelectList<RealEstateCRM.Models.Common.DocumentTemplateType>()"
                                class="select"></select>
                    </div>

                    <div>
                        <label asp-for="FileTemplatePath"></label>
                        <input asp-for="FileTemplatePath" class="input" />
                    </div>

                    <div>
                        <label>
                            <input asp-for="IsActive" />
                            Активен шаблон
                        </label>
                    </div>
                </div>
            </div>

            <!-- JSON SCHEMA -->
            <div class="section">
                <h4>Json Schema (Dynamic Fields)</h4>

                <textarea asp-for="JsonSchema"
                          id="json-schema"
                          class="textarea"></textarea>

                <div id="json-status" style="margin-top:6px;"></div>

                <div class="helper-box">
                    Формат:
<pre>[
  { "name": "ClientName", "type": "text", "label": "Client Name", "required": true },
  { "name": "Price", "type": "number", "label": "Price" },
  { "name": "ContractDate", "type": "date", "label": "Date" },
  { "name": "Description", "type": "textarea", "label": "Description" }
]</pre>
                    Поддържани типове: text, number, date, textarea
                </div>
            </div>

            <div class="actions">
                <button class="btn" type="submit">Запази</button>
                <a class="btn secondary" asp-action="Index">Отказ</a>
            </div>

        </form>

    </div>

</div>

@section Scripts {
<script>

(function () {

    const textarea = document.getElementById('json-schema');
    const status = document.getElementById('json-status');

    function validateJson() {

        const value = textarea.value.trim();

        if (!value) {
            status.innerHTML = '';
            return;
        }

        try {
            JSON.parse(value);
            status.innerHTML = '<span class="json-valid">✔ Валиден JSON</span>';
        }
        catch (e) {
            status.innerHTML = '<span class="json-invalid">✖ Невалиден JSON</span>';
        }
    }

    textarea.addEventListener('input', validateJson);
    validateJson();

})();
</script>
}
